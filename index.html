<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Bank & "Market"</title>
	<script type="text/javascript">
		function _id(id) { return document.getElementById(id); };
		function _s(s) { return document.querySelectorAll(s); };
		function _ev(el,nm,fn) {
			if (!el) {
				return
			}
			if (el instanceof NodeList) {
				for (var i=0;i<el.length;i++) {
					el.item(i).addEventListener(nm,fn)
				}
			}
			else {
				el.addEventListener(nm,fn)
			}
		}
		function _ce(t,ats,h) {
			var e=document.createElement(t);
			for (var k in ats) {
				e.setAttribute(k,ats[k])
			}
			e.innerHTML=h;
			return e
		}

		const purse_letters = " qwertyuiopasdfghjklzxcvbnm".split("");
		const fx_reverse_map = ["F10", "F1", "F2", "F3", "F4", "F5", "F6", "F7", "F8", "F9"];

		var ST = window.localStorage;
		var PRFX = "mbm18xxapp_";

		var curr_transfer = {};
		var monies = {};
		var starting_bank;
		var log = [];

		function click_handler(e) {
			var target = e.target.id.indexOf("purse_") !== 0 ? e.target.parentNode : e.target;
			select_purse(target.id.replace("purse_", ""));

		}
		function select_purse(id) {
			if (id == -1) {
				if (_s(".purse.selected").length > 0) {
					_s(".purse.selected")[0].classList.toggle("selected");
				}
				curr_transfer = {};
				return;
			}
			if (_s("#purse_"+id).length == 0) {
				return;
			}
			if (typeof curr_transfer.from == "undefined") {
				curr_transfer.from = id;
				_s("#purse_"+id)[0].classList.toggle("selected");
			}
			else if (curr_transfer.from != id) {
				mid_transfer(id);
			}
			else {
				_s("#purse_"+id)[0].classList.toggle("selected");
				curr_transfer = {};
			}
		}
		function mid_transfer(to_id) {
			curr_transfer.to = +to_id;

			_s("#from")[0].innerHTML = monies[curr_transfer.from].label;
			_s("#to")[0].innerHTML = monies[curr_transfer.to].label;
			var prev_inputs = _s("#previous span");
			var i;
			for (i = 0; i < prev_inputs.length; i++) {
				prev_inputs[i].remove();
			}

			var prev_container = _s("#previous")[0];
			var spacer = _s("previous .spacer")[0];
			var prevs = get_prevs();
			console.log(prevs);
			for (i in prevs) {
				prev_container.insertBefore(_ce("span", {"class":"warning","data-letter":purse_letters[prevs.length - i]}, prevs[i],), prev_container.firstChild);
			}
			_ev(_s("#previous span"), "click", end_transfer);
			_s("#transfer")[0].style.display = "block";
			_s("#tamount")[0].focus();
			_s("#tamount")[0].select();
		}
		function end_transfer(e) {
			if (e.target && e.target.parentNode == _s('#previous')[0]) {
				var parts = e.target.innerHTML.split("x");
				transfer(curr_transfer.from, curr_transfer.to, parts[0], parts[1]);
			}
			else {
				transfer(curr_transfer.from, curr_transfer.to, _s("#tamount")[0].value, _s("#tamount_mul")[0].value);
			}
			_s("#transfer")[0].style.display = "none";
			update_purses([curr_transfer.from, curr_transfer.to]);
			_s("#purse_"+curr_transfer.from)[0].classList.toggle("selected");
			curr_transfer = {};
		}
		var last_mark_time;
		function mark_log_line(e) {
			if (Date.now() - last_mark_time < 500) {
				return;
			}
			var colors = ["", "#880000", "#008800", "#000088"];
			var cci = typeof e.target.dataset.bgc == "undefined" ? 0 : +e.target.dataset.bgc;
			if (cci == colors.length - 1) {
				e.target.style.backgroundColor = colors[0]
				e.target.dataset.bgc = 0;
			}
			else {
				e.target.style.backgroundColor = colors[cci + 1];
				e.target.dataset.bgc = cci + 1;
			}
			last_mark_time = Date.now();
		}
		function transfer(from, to, amount, mul) {
			monies[from].amount = (+monies[from].amount) - (+amount)*(+mul);
			monies[to].amount = (+monies[to].amount) + (+amount)*(+mul);
			log.push({"from":from, "to":to, "amount":amount, "mul":mul});
			_s('#log_display')[0].appendChild(_ce("div", {"class":"log_line", "id":"log_entry_"+(log.length - 1)}, _s("#purse_"+from+" .name")[0].innerHTML + " ==> " + _s("#purse_"+to+" .name")[0].innerHTML  + " " + amount + "x" + (mul ? mul : 1)));
			_s('#log_display')[0].scrollTop = _s('#log_display')[0].scrollHeight;
			_ev(_s('#log_display')[0], "click", mark_log_line);

			ST.setItem(PRFX + "log", JSON.stringify(log));
			ST.setItem(PRFX + "monies", JSON.stringify(monies));
		}
		function transfer_cancel() {
			_s("#transfer")[0].style.display = "none";
			curr_transfer = {};
			select_purse(-1);
		}
		function undo_last() {
			let last = log.splice(log.length - 1, 1)[0];
			monies[last.from].amount = (+monies[last.from].amount) + (+last.amount)*(+last.mul);
			monies[last.to].amount = (+monies[last.to].amount) - (+last.amount)*(+last.mul);
			update_purses([last.from, last.to]);

			_s('#log_display')[0].lastChild.remove();
			_s('#log_display')[0].scrollTop = _s('#log_display')[0].scrollHeight;

			ST.setItem(PRFX + "log", JSON.stringify(log));
			ST.setItem(PRFX + "monies", JSON.stringify(monies));
		}
		function undo_click(e) {
			if (e.ctrlKey) {
				undo_last();
				e.preventDefault();
				e.stopPropagation();
				return false;
			}
		}
		
		function get_prevs() {
			if (!log.length) return [];
			var prevs = [], transfered;
			for (var i = log.length - 1; i >= 0 && prevs.length < 20; i--) {
				transfered = log[i].amount+"x"+log[i].mul;
				if (prevs.indexOf(transfered) == -1) {
					prevs.unshift(transfered);
				}
			}
			return prevs;
		}
		
		function update_purses(purses) {
			for (var i = 0; i<purses.length; i++) {
				_s("#purse_"+purses[i]+" .amount")[0].innerHTML = monies[purses[i]].amount;
			}
		}

		function save() {
			var existing_purses = _s("#display .purse");
			for (var i = 0; i<existing_purses.length; i++) {
				existing_purses[i].remove();
			}
			var existing_log_lines = _s("#log_display .log_line");
			for (var i = 0; i<existing_log_lines.length; i++) {
				existing_log_lines[i].remove();
			}
			monies = {};
			log = [];
			starting_bank = monies[0] = {amount:+_s("#bank_size")[0].value, label:"Bank"};
			var nodes = _s('#purse_list div');
			var node;
			var i = 1;
			while ((node = nodes.item(i - 1)) && node.children[0].value) {
				let [name, color] = node.children[0].value.split("=");
				monies[i] = {amount:0, label:name};
				if (color) {
					monies[i].color = color;
				}
				i++;
			}
			setup_display();
			ST.setItem(PRFX + "starting_bank", JSON.stringify(starting_bank));
			ST.setItem(PRFX + "log", JSON.stringify(log));
			ST.setItem(PRFX + "monies", JSON.stringify(monies));
		}
		function setup_display() {
			_s("#setup")[0].style.display = "none";
			var d = _s("#display")[0];
			var i = 1;
			for (i in monies) {
				let indicator = monies[i].color ? '<span class="indicator" style="background-color:'+monies[i].color+';"></span>' : "";
				d.appendChild(_ce("div", {"class":"purse", id:"purse_"+i}, '<span class="name">'+monies[i].label+'</span>  <span class="amount" data-letter="'+purse_letters[i]+'">'+monies[i].amount+'</amount>' + indicator));
			}
			_ev(_s("#display .purse"), "click", click_handler);
			var purses = _s("#display .purse");
			for (i = 0; i < purses.length; i++) {
				_ev(purses[i], "drop", (function (el) { return function (e) { mid_transfer(e, el); }; })(purses[i]))
			}
			_s("#display")[0].style.display = "block";
			_s("#log_display")[0].style.display = "block";
		}
		function del_purse(e) {
			if (_s('#purse_list div').length > 1) {
				e.target.parentNode.remove();
			}
		}
		function make_purse() {
			if (_s('#purse_list div').length && _s('#purse_list div:last-child input[type="text"]')[0].value == "") {
				return;
			}
			var list = _s('#purse_list')[0];
			list.appendChild(_ce('div', {'class':"purse_row"}, '<input type="text" value="" placeholder="name" class="purse_name"> <span class="remove_purse warning"></span>'));
			_ev(_s('#purse_list div:last-child input[type="text"]'), 'keyup', make_purse);
			_ev(_s('#purse_list div:last-child .remove_purse'), 'click', del_purse);
		}
		function setup_cancel() {
			_s("#setup")[0].style.display = "none";
			_s("#display")[0].style.display = "block";
			_s("#log_display")[0].style.display = "block";
		}
		function setup_show() {
			_s("#setup")[0].style.display = "block";
			_s("#display")[0].style.display = "none";
			_s("#log_display")[0].style.display = "none";
		}
		
		function keyboard_handler(e) {
			console.log(e);
			let purse_id = purse_letters.indexOf(e.key.toLowerCase());
			let handled = false;

			if (e.ctrlKey) {//avoid overiding browser binds
			}
			else if (_s('#setup')[0].style.display != "none") {
			}
			else if (typeof curr_transfer.to != "undefined") {
				let f_id = fx_reverse_map.indexOf(e.key);
				if (e.key == "Escape") {
					transfer_cancel();
					handled = true;
				}
				else if (purse_id > 0) {
					let selected = _s("#previous span")[purse_id - 1];
					if (selected) {
						end_transfer({target:selected});
					}
					handled = true;
				}
				else if (e.key == "Enter" && _s("#tamount")[0].value && _s("#tamount_mul")[0].value) {
					end_transfer({});
					handled = true;
				}
				else if (f_id > 0 && _s("#tamount")[0].value) {
					_s("#tamount_mul")[0].value = f_id;
					end_transfer({});
					handled = true;
				}
			}
			else if (purse_id != -1 && typeof curr_transfer.to == "undefined") {
				if (e.key.toLowerCase() != e.key) {
					select_purse(-1);
					select_purse(purse_id);
					select_purse(0);
				}
				else if (curr_transfer.from == purse_id) {
					select_purse(-1);
					select_purse(0);
					select_purse(purse_id);
				}
				else {
					select_purse(purse_id);
				}
				handled = true;
			}
			if (handled) {
				e.preventDefault();
				e.stopPropagation();
				return false;
			}
			return true;
		}
		document.addEventListener('DOMContentLoaded', function () {
			make_purse();
			_ev(_s('#save'), 'click', save);
			_ev(_s('#send'), 'click', end_transfer);
			_ev(_s('#transfer_cancel'), 'click', transfer_cancel);
			_ev(_s('#setup_cancel'), 'click', setup_cancel);
			_ev(_s('#setup_icon'), 'click', setup_show);

			var existing_log = ST.getItem(PRFX + "log");
			if (existing_log != null) {
				log = JSON.parse(existing_log);
				monies = JSON.parse(ST.getItem(PRFX + "monies"));
				starting_bank = JSON.parse(ST.getItem(PRFX + "starting_bank"));
				setup_display();

				//XXX much reapeat with top, possibly fix that
				var logdiv = _s('#log_display')[0];
				var i, ll;
				for (i in log) {
					ll = log[i];
					logdiv.appendChild(_ce("div", {"class":"log_line", "id":"log_entry_"+i}, _s("#purse_"+ll.from+" .name")[0].innerHTML + " ==> " + _s("#purse_"+ll.to+" .name")[0].innerHTML  + " " + ll.amount + "x" + (ll.mul ? ll.mul : 1)));
				}

				logdiv.scrollTop = _s('#log_display')[0].scrollHeight;
				_ev(logdiv, "click", mark_log_line);
				_ev(document, 'keydown', keyboard_handler);
				_ev(_s('#undo')[0], "click", undo_click);
			}
		});
	</script>
	<style type="text/css">
		#setup_icon {width:32px;height:32px;position:absolute;top:5px;left:5px;border-radius:16px;border:3px green dashed;background-color:black;}
		#setup_icon:before {width:22px;height:22px;position:absolute;top:-1px;left:-1px;border-radius:16px;background-color:black;border:3px green dashed;content:"";display:inline-block;}
		* {box-sizing:border-box;}
		html {width:100%;}
		body {color:lightgray;background-color:black;width:100%;margin:0;}
		/*#setup {display:none;}*/
		#display, #setup {width:100%;}

		#bank_row {margin:10px 3px;text-align:justify;}
		label {display:inline-block;}
		.breaker {display:inline-block;height:1px;width:50%;}
		#bank_size {display:inline-block;margin-right:20px;}
		#purse_list {margin-top:15px; width:100%;}
		.purse_row {width:100%;padding:7px 3px;border-radius:5px;margin:2px 0;}
		.purse_row:nth-child(2n) {background-color:#333;}
		.purse_row:nth-child(2n+1) {background-color:darkslategray;}
		.purse_row input {margin-left:5px;}
		.purse_name {width:20em;}
		.remove_purse, #transfer_cancel, #setup_cancel {
			margin-top:1px;
			margin-right:4px;
			display:inline-block;
			width:32px;
			height:32px;
			float:right;
			text-align:center;
			padding:4px;
		}
		#transfer_cancel {position:absolute;right:10px;top:10px;}
		#display {text-align:center;}
		.purse {text-align:center;border-radius:5px;background:#333;padding:5px;margin:10px;display:inline-block;width:30%; max-width:15em;;font-weight:bold; font-size:larger;border:5px solid transparent;}
		.purse.selected {border:5px green solid;box-shadow:0 0 5px 3px green, 0 0 5px 3px green inset;}
		.purse .name {color:white;display:inline-block;}
		.purse .amount {color:green;display:block;font-size:24px;}
		.purse .amount:after, #previous span:before {display:block;float:right;padding:0 4px 4px 4px;color:black;background:gainsboro;border:3px outset gainsboro;content:attr(data-letter);font:fixed;margin:0;margin-top:-3px;border-radius:5px;text-align:middle;}
		#purse_0 {width:90%;margin:10px auto;max-width:90%;}
		#purse_0 .amount:after {content:"         ";height:15px;}
		.remove_purse:before, #transfer_cancel:before, #setup_cancel:before {content:"X";display:inline-block;}
		.indicator {display:block;width:32px;height:32px;border-radius:16px;float:left;}
		#save_container {text-align:center;margin-top:10px;}
		#save {font-size:large;padding:3px 10px;}
		.warning {
			color:black;
			background-color:#bb0000;
			border-top:3px solid red;
			border-left:3px solid red;
			border-bottom:3px solid darkred;
			border-right:3px solid darkred;
			font-weight:bold;
			font-family:sans-serif;
			border-radius:3px;
		}
		#transfer {display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:#000;font-size:larger;font-weight:bold;}
		#topt {margin:20px auto;width:50%;background:#333;border-radius:5px;text-align:center;padding:10px;position:relative;}
		#dir {margin:5px;display:inline-block;font-size:larger;}
		#dir #send {font-size:smaller;margin:0px 10px;}
		#topt input {font-size:larger;font-weight:bold;}
		#topt input[type="number"] {height:1em;width:6em;}
		#tamount_container {margin:10px auto;}
		#previous {margin:10px auto;max-width:24em;text-align:justify;}
		#previous span {width:7em; display:inline-block;margin:10px 0px;text-align:center;overflow:hidden;;}
		#previous span:before {float:left;padding:0 2px 2px 2px;margin-top:0;font-size:small;border-width:2px}
		.spacer {display:inline-block;height:1px;width:99%;}
		#log_display {width:100%;max-height:10em;overflow-y:scroll;margin:auto;color:white;font-weight:bold;border:3px solid #333;margin-top:20px;}
		#log_display .log_line {padding:3px;margin:2px;}
		#log_display .log_line:nth-child(6n), #log_display .log_line:nth-child(6n+1), #log_display .log_line:nth-child(6n+2) {background:#333;}
		#log_display .log_line:last-child {font-size:larger;color:yellow;}
		#global_buttons {padding:0 10px;}
		#undo {background-color:gainsboro;width:48px;height:48px;border-radius:5px;padding:2px;border:3px outset gainsboro;}
	</style>
</head>

<body>
	<div id="setup_icon"></div>
	<div id="setup">
		<div id="setup_cancel" class="warning"></div>
		<div id="bank_row"><label for="bank_size">Bank size:</label> <input type="text" id="bank_size" value="999999"> <span class="breaker"></span></div>
		<div id="purse_list">
		</div>
		<div id="save_container">
			<input type="button" id="save" value="Save &amp; Use" class="warning">
		</div>
	</div>
	<div id="display">
	</div>
	<div id="global_buttons">
		<svg version="1.1" id="undo" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="430.924px" height="430.924px" viewBox="0 0 430.924 430.924" style="enable-background:new 0 0 430.924 430.924;" >
			<g>
				<g>
					<path d="M134,403.243c22.641,10.875,47.469,17.813,73.719,19.813v-64.813c-14.594-1.625-28.672-4.906-41.625-10.594L134,403.243z"/>
					<path d="M366.109,199.868h64.814c-8.25-107.219-97.939-192-207.203-192c-64.282,0-124.719,30.094-163.813,79.969L0.125,53.274 L0,251.118l171.391-98.813l-55.094-31.875c27.063-30.313,66-48.563,107.421-48.563 C297.672,71.868,358.047,128.055,366.109,199.868z"/>
					<path d="M108.219,301.024l-55.984,32.312c14.531,21.156,32.859,39.47,54.016,54.031l32.313-56 C126.985,322.805,116.782,312.586,108.219,301.024z"/>
					<path d="M239.735,358.243v64.813c26.25-2,51.063-8.938,73.688-19.813l-32.064-55.594 C268.359,353.336,254.297,356.618,239.735,358.243z"/>
					<path d="M308.859,331.368l32.314,56c21.188-14.562,39.5-32.875,54.062-54.031l-56-32.312 C330.672,312.586,320.484,322.805,308.859,331.368z"/>
					<path d="M355.547,273.461l55.562,32.094c10.875-22.625,17.814-47.438,19.814-73.688h-64.814 C364.484,246.461,361.172,260.524,355.547,273.461z"/>
				</g>
			</g>
		</svg>
	</div>
	<div id="log_display">
	</div>
	<div id="transfer">
		<div id="topt">
			<div id="transfer_cancel" class="warning"></div>
			<div id="dir">
				<span id="from">Linda</span> <input id="send" class="warning" type="button" value="=&gt;"> <span id="to">Bank</span>
			</div>
			<div id="tamount_container">
				<input id="tamount" type="number" min="1"> x <input id="tamount_mul" type="number" min="1" value="1">
			</div>
			<div id="previous">
				<span class="spacer"></span>
			</div>
		</div>
	</div>
</body>
</html>
